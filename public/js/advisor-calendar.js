require(["util/site","util/calendar","moment"],function(e,t,a){e.ajaxcrsf(),t.init(!0);var i=function(){$.ajax({method:"GET",url:"/advising/conflicts",dataType:"json"}).success(function(e,t,a){$(document).off("click",".deleteConflict",o),$(document).off("click",".editConflict",r),$(document).off("click",".resolveConflict",c),200==a.status?($("#resolveConflictMeetings").empty(),$.each(e,function(e,t){$("<div/>",{"class":"meeting-conflict",html:'<p>&nbsp;<button type="button" class="btn btn-danger pull-right deleteConflict" data-id='+t.id+'>Delete</button>&nbsp;<button type="button" class="btn btn-primary pull-right editConflict" data-id='+t.id+'>Edit</button> <button type="button" class="btn btn-success pull-right resolveConflict" data-id='+t.id+'>Keep Meeting</button><span id="resolveSpin'+t.id+'" class="fa fa-cog fa-spin fa-lg pull-right hide-spin">&nbsp;</span><b>'+t.title+"</b> ("+t.start+")</p><hr>"}).appendTo("#resolveConflictMeetings")}),$(document).on("click",".deleteConflict",o),$(document).on("click",".editConflict",r),$(document).on("click",".resolveConflict",c),$("#conflictingMeetings").removeClass("hidden")):204==a.status&&$("#conflictingMeetings").addClass("hidden")}).fail(function(e,t){alert("Unable to retrieve conflicting meetings: "+e.responseJSON)})},n=function(){$("#createBlackoutSpin").removeClass("hide-spin");var t,n={bstart:a($("#bstart").val(),"LLL").format(),bend:a($("#bend").val(),"LLL").format(),btitle:$("#btitle").val()};$("#bblackouteventid").val()>0?(t="/advising/createblackoutevent",n.bblackouteventid=$("#bblackouteventid").val()):(t="/advising/createblackout",$("#bblackoutid").val()>0&&(n.bblackoutid=$("#bblackoutid").val()),n.brepeat=$("#brepeat").val(),1==$("#brepeat").val()&&(n.brepeatevery=$("#brepeatdaily").val(),n.brepeatuntil=a($("#brepeatuntil").val(),"MM/DD/YYYY").format()),2==$("#brepeat").val()&&(n.brepeatevery=$("#brepeatweekly").val(),n.brepeatweekdaysm=$("#brepeatweekdays1").prop("checked"),n.brepeatweekdayst=$("#brepeatweekdays2").prop("checked"),n.brepeatweekdaysw=$("#brepeatweekdays3").prop("checked"),n.brepeatweekdaysu=$("#brepeatweekdays4").prop("checked"),n.brepeatweekdaysf=$("#brepeatweekdays5").prop("checked"),n.brepeatuntil=a($("#brepeatuntil").val(),"MM/DD/YYYY").format())),$.ajax({method:"POST",url:t,data:n}).success(function(t){$("#createBlackout").modal("hide"),e.displayMessage(t,"success"),$("#calendar").fullCalendar("unselect"),$("#calendar").fullCalendar("refetchEvents"),$("#createBlackoutSpin").addClass("hide-spin"),i()}).fail(function(t,a){422==t.status?e.setFormErrors(t.responseJSON):alert("Unable to save blackout: "+t.responseJSON),$("#createBlackoutSpin").addClass("hide-spin")})},l=function(){var t=confirm("Are you sure?");if(t===!0){$("#createBlackoutSpin").removeClass("hide-spin");var a,n;$("#bblackouteventid").val()>0?(a="/advising/deleteblackoutevent",n={bblackouteventid:$("#bblackouteventid").val()}):(a="/advising/deleteblackout",n={bblackoutid:$("#bblackoutid").val()}),$.ajax({method:"POST",url:a,data:n}).success(function(t){$("#createBlackout").modal("hide"),e.displayMessage(t,"success"),$("#calendar").fullCalendar("unselect"),$("#calendar").fullCalendar("refetchEvents"),$("#createBlackoutSpin").addClass("hide-spin"),i()}).fail(function(e,t){alert("Unable to delete blackout: "+e.responseJSON),$("#createBlackoutSpin").addClass("hide-spin")})}},d=function(){0==$(this).val()?($("#repeatdailydiv").hide(),$("#repeatweeklydiv").hide(),$("#repeatuntildiv").hide()):1==$(this).val()?($("#repeatdailydiv").show(),$("#repeatweeklydiv").hide(),$("#repeatuntildiv").show()):2==$(this).val()&&($("#repeatdailydiv").hide(),$("#repeatweeklydiv").show(),$("#repeatuntildiv").show())},s=function(){$("#resolveConflict").modal("show")},o=function(){var e=$(this),t=$(this).data("id"),a=confirm("Are you sure?");a===!0&&($("#resolveSpin"+t).removeClass("hide-spin"),$.ajax({method:"POST",url:"/advising/deletemeeting",data:{meetingid:t}}).success(function(a){$("#resolveSpin"+t).addClass("hide-spin"),e.parent().parent().addClass("hidden")}).fail(function(e,a){alert("Unable to delete meeting: "+e.responseJSON),$("#resolveSpin"+t).addClass("hide-spin")}))},r=function(){var e=($(this),$(this).data("id"));$("#resolveSpin"+e).removeClass("hide-spin"),$.ajax({method:"get",url:"/advising/meeting",data:{meetingid:e}}).success(function(i){$("#resolveSpin"+e).addClass("hide-spin"),$("#resolveConflict").modal("hide"),event=JSON.parse(i),event.start=a(event.start),event.end=a(event.end),t.showMeetingForm(event)}).fail(function(t,a){$("#resolveSpin"+e).addClass("hide-spin"),alert("Unable to retrieve meeting: "+t.responseJSON)})},c=function(){var e=$(this),t=$(this).data("id");$("#resolveSpin"+t).removeClass("hide-spin"),$.ajax({method:"POST",url:"/advising/resolveconflict",data:{meetingid:t}}).success(function(a){$("#resolveSpin"+t).addClass("hide-spin"),e.parent().parent().addClass("hidden")}).fail(function(e,a){alert("Unable to resolve: "+e.responseJSON),$("#resolveSpin"+t).addClass("hide-spin")})},u=function(){$("#btitle").val(""),void 0===t.session.start?$("#bstart").val(a().hour(8).minute(0).format("LLL")):$("#bstart").val(t.session.start.format("LLL")),void 0===t.session.end?$("#bend").val(a().hour(9).minute(0).format("LLL")):$("#bend").val(t.session.end.format("LLL")),$("#bblackoutid").val(-1),$("#repeatdiv").show(),$("#brepeat").val(0),$("#brepeat").trigger("change"),$("#deleteBlackoutButton").hide(),$("#createBlackout").modal("show")},p=function(){$("#blackoutOption").modal("hide"),$("#btitle").val(t.session.event.title),$("#bstart").val(t.session.event.start.format("LLL")),$("#bend").val(t.session.event.end.format("LLL")),$("#repeatdiv").hide(),$("#repeatdailydiv").hide(),$("#repeatweeklydiv").hide(),$("#repeatuntildiv").hide(),$("#bblackoutid").val(t.session.event.blackout_id),$("#bblackouteventid").val(t.session.event.id),$("#deleteBlackoutButton").show(),$("#createBlackout").modal("show")},v=function(){$("#blackoutOption").modal("hide"),$.ajax({method:"GET",url:"/advising/blackout",data:{id:t.session.event.blackout_id},dataType:"json"}).success(function(e){$("#btitle").val(e.title),$("#bstart").val(a(e.start,"YYYY-MM-DD HH:mm:ss").format("LLL")),$("#bend").val(a(e.end,"YYYY-MM-DD HH:mm:ss").format("LLL")),$("#bblackoutid").val(e.id),$("#bblackouteventid").val(-1),$("#repeatdiv").show(),$("#brepeat").val(e.repeat_type),$("#brepeat").trigger("change"),1==e.repeat_type?($("#brepeatdaily").val(e.repeat_every),$("#brepeatuntil").val(a(e.repeat_until,"YYYY-MM-DD HH:mm:ss").format("MM/DD/YYYY"))):2==e.repeat_type&&($("#brepeatweekly").val(e.repeat_every),$("#brepeatweekdays1").prop("checked",e.repeat_detail.indexOf("1")>=0),$("#brepeatweekdays2").prop("checked",e.repeat_detail.indexOf("2")>=0),$("#brepeatweekdays3").prop("checked",e.repeat_detail.indexOf("3")>=0),$("#brepeatweekdays4").prop("checked",e.repeat_detail.indexOf("4")>=0),$("#brepeatweekdays5").prop("checked",e.repeat_detail.indexOf("5")>=0),$("#brepeatuntil").val(a(e.repeat_until,"YYYY-MM-DD HH:mm:ss").format("MM/DD/YYYY"))),$("#deleteBlackoutButton").show(),$("#createBlackout").modal("show")}).fail(function(e,t){alert("Unable to retrieve blackout series: "+e.responseJSON)})},b=function(){var e=prompt("Enter the student's eID"),t={eid:e};$.ajax({method:"POST",url:"/profile/newstudent",data:t}).success(function(e){alert(e)}).fail(function(e,t){422==e.status?alert("Unable to create user: "+e.responseJSON.eid):alert("Unable to create user: "+e.responseJSON)})};$("#newStudentButton").bind("click",b),$("#createBlackout").on("shown.bs.modal",function(){$("#btitle").focus()}),$("#createBlackout").on("hidden.bs.modal",function(){$("#repeatdailydiv").hide(),$("#repeatweeklydiv").hide(),$("#repeatuntildiv").hide(),$(this).find("form")[0].reset(),$(this).find(".has-error").each(function(){$(this).removeClass("has-error")}),$(this).find(".help-block").each(function(){$(this).text("")})}),$("#createEvent").on("hidden.bs.modal",i),$("#resolveConflict").on("hidden.bs.modal",i),$("#resolveConflict").on("hidden.bs.modal",function(){$("#calendar").fullCalendar("refetchEvents")}),$("#studentid").autocomplete({serviceUrl:"/profile/studentfeed",ajaxSettings:{dataType:"json"},onSelect:function(e){$("#studentidval").val(e.data)},transformResult:function(e){return{suggestions:$.map(e.data,function(e){return{value:e.value,data:e.data}})}}}),$("#start_datepicker").datetimepicker(t.datePickerData),$("#end_datepicker").datetimepicker(t.datePickerData),t.linkDatePickers("#start","#end","#duration"),$("#bstart_datepicker").datetimepicker(t.datePickerData),$("#bend_datepicker").datetimepicker(t.datePickerData),t.linkDatePickers("#bstart","#bend","#bduration"),$("#brepeatuntil_datepicker").datetimepicker(t.datePickerDateOnly),t.calendarData.eventSources[0].data={id:t.calendarAdvisorID},t.calendarData.eventSources[1].data={id:t.calendarAdvisorID},t.calendarData.eventRender=function(e,t){t.addClass("fc-clickable")},t.calendarData.eventClick=function(e,a,i){"m"==e.type?($("#studentid").val(e.studentname),$("#studentidval").val(e.student_id),t.showMeetingForm(e)):"b"==e.type&&(t.session={event:e},"0"==e.repeat?v():$("#blackoutOption").modal("show"))},t.calendarData.select=function(e,a){t.session={start:e,end:a},$("#bblackoutid").val(-1),$("#bblackouteventid").val(-1),$("#meetingID").val(-1),$("#meetingOption").modal("show")},$(window).width()<600&&(t.calendarData.defaultView="agendaDay"),$("#calendar").fullCalendar(t.calendarData),$("#brepeat").change(d),$("#saveBlackoutButton").bind("click",n),$("#deleteBlackoutButton").bind("click",l),$("#blackoutSeries").bind("click",function(){$("#blackoutOption").modal("hide"),v()}),$("#blackoutOccurrence").bind("click",function(){$("#blackoutOption").modal("hide"),p()}),$("#advisingButton").bind("click",function(){$("#meetingOption").modal("hide"),t.createMeetingForm()}),$("#createMeetingBtn").bind("click",function(){t.session={},t.createMeetingForm()}),$("#blackoutButton").bind("click",function(){$("#meetingOption").modal("hide"),u()}),$("#createBlackoutBtn").bind("click",function(){t.session={},u()}),$("#resolveButton").on("click",s),i()});